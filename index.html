<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - ABA Bank</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header><h1>ABA Bank Portal</h1></header>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="customers.html">Customers</a></li>
            <li><a href="accounts.html">Accounts</a></li>
            <li><a href="transactions.html">Transactions</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Create Customer Section (Same as before) -->
        <section id="create-customer-section" class="form-section">
            <h2>Create New Customer</h2>
            <form id="createCustomerForm">
                <div><label for="custFullName">Full Name:</label><input type="text" id="custFullName" required></div>
                <div><label for="custEmail">Email (Optional):</label><input type="email" id="custEmail"></div>
                <div><label for="custPhone">Phone (Optional):</label><input type="tel" id="custPhone"></div>
                <button type="submit">Create Customer</button>
            </form>
            <div id="createCustomerResponse" class="api-response" style="display:none;"></div>
        </section>

        <!-- View/Update Customer Section (Same as before, but we'll ensure currentCustomerIdForLocation is set) -->
        <section class="form-section">
            <h2>View / Update Customer</h2>
            <div>
                <label for="viewCustomerId">Customer ID:</label>
                <input type="text" id="viewCustomerId" placeholder="Enter Customer UUID to view/update/report location">
                <button onclick="fetchCustomerDetails()">View Details</button>
            </div>
            <div id="customerDetailsArea" style="display:none; margin-top:15px;">
                <h3>Customer Details:</h3>
                <form id="updateCustomerForm">
                    <input type="hidden" id="updateCustIdHidden">
                    <div><label for="updateFullName">Full Name:</label><input type="text" id="updateFullName"></div>
                    <div><label for="updateEmail">Email:</label><input type="email" id="updateEmail"></div>
                    <div><label for="updatePhone">Phone:</label><input type="tel" id="updatePhone"></div>
                    <button type="submit">Update Customer</button>
                </form>
                <div id="currentLocationInfo" class="info-box" style="margin-top:10px; display:none;">
                    <h4>Last Reported Location:</h4>
                    <p id="locLat">Lat: N/A</p>
                    <p id="locLon">Lon: N/A</p>
                    <p id="locAcc">Accuracy: N/A</p>
                    <p id="locTime">Timestamp: N/A</p>
                </div>
                <h4>Linked Accounts:</h4>
                <ul id="customerAccountsList"></ul>
            </div>
            <div id="viewCustomerResponse" class="api-response" style="display:none;"></div>
        </section>

        <!-- Report Customer Location Section (NEW) -->
        <section id="report-location-section" class="form-section" style="display:none;">
            <h2>Report Customer Location</h2>
            <form id="reportLocationForm">
                <div>
                    <label for="locLatitude">Latitude (-90 to 90):</label>
                    <input type="number" id="locLatitude" step="any" min="-90" max="90" required>
                </div>
                <div>
                    <label for="locLongitude">Longitude (-180 to 180):</label>
                    <input type="number" id="locLongitude" step="any" min="-180" max="180" required>
                </div>
                <div>
                    <label for="locAccuracy">Accuracy (meters, Optional):</label>
                    <input type="number" id="locAccuracy" step="any" min="0">
                </div>
                <button type="button" onclick="autofillBrowserLocation()">Use Browser Location (if available)</button>
                <button type="submit" style="margin-top:10px;">Report Location</button>
            </form>
            <div id="reportLocationResponse" class="api-response" style="display:none;"></div>
        </section>
    </div>

    <script src="js/main.js"></script>
    <script>
        let currentCustomerIdForLocation = null; // To store the ID of the customer whose location we're reporting

        // Create Customer (Same as before)
        document.getElementById('createCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                full_name: document.getElementById('custFullName').value,
                email: document.getElementById('custEmail').value || null,
                phone_number: document.getElementById('custPhone').value || null,
            };
            if (!payload.email) delete payload.email;
            if (!payload.phone_number) delete payload.phone_number;

            try {
                const data = await apiCall('/customers/', 'POST', payload);
                showResponse('createCustomerResponse', 'Customer created successfully!\nID: ' + data.id + '\n\n' + JSON.stringify(data, null, 2));
                document.getElementById('createCustomerForm').reset();
            } catch (error) {
                showResponse('createCustomerResponse', 'Error: ' + error.message, false);
            }
        });

        // Fetch Customer Details (Modified to show location section and current location)
        async function fetchCustomerDetails() {
            const customerIdInput = document.getElementById('viewCustomerId').value;
            const detailsArea = document.getElementById('customerDetailsArea');
            const accountsList = document.getElementById('customerAccountsList');
            const reportLocationSection = document.getElementById('report-location-section');
            const currentLocationInfoDiv = document.getElementById('currentLocationInfo');


            if (!customerIdInput) {
                showResponse('viewCustomerResponse', 'Please enter a Customer ID.', false);
                detailsArea.style.display = 'none';
                reportLocationSection.style.display = 'none';
                currentLocationInfoDiv.style.display = 'none';
                currentCustomerIdForLocation = null;
                return;
            }
            currentCustomerIdForLocation = customerIdInput; // Set for location reporting
            detailsArea.style.display = 'none';
            reportLocationSection.style.display = 'none';
            currentLocationInfoDiv.style.display = 'none';
            accountsList.innerHTML = '';
            showResponse('viewCustomerResponse', 'Fetching details...', true);

            try {
                const customerData = await apiCall(`/customers/${currentCustomerIdForLocation}`, 'GET');
                document.getElementById('updateCustIdHidden').value = customerData.id;
                document.getElementById('updateFullName').value = customerData.full_name;
                document.getElementById('updateEmail').value = customerData.email || '';
                document.getElementById('updatePhone').value = customerData.phone_number || '';

                // Display current location
                document.getElementById('locLat').textContent = `Lat: ${customerData.last_known_latitude !== null ? customerData.last_known_latitude : 'N/A'}`;
                document.getElementById('locLon').textContent = `Lon: ${customerData.last_known_longitude !== null ? customerData.last_known_longitude : 'N/A'}`;
                document.getElementById('locAcc').textContent = `Accuracy: ${customerData.last_location_accuracy !== null ? customerData.last_location_accuracy + 'm' : 'N/A'}`;
                document.getElementById('locTime').textContent = `Timestamp: ${customerData.last_location_timestamp ? formatDate(customerData.last_location_timestamp) : 'N/A'}`;
                currentLocationInfoDiv.style.display = 'block';


                detailsArea.style.display = 'block';
                reportLocationSection.style.display = 'block'; // Show location reporting form
                showResponse('viewCustomerResponse', 'Customer details loaded.', true);

                const customerAccounts = await apiCall(`/customers/${currentCustomerIdForLocation}/accounts`, 'GET');
                if (customerAccounts.length > 0) {
                    customerAccounts.forEach(acc => {
                        const li = document.createElement('li');
                        li.innerHTML = `Acc No: <code>${acc.account_number}</code>, Type: ${acc.account_type}, Balance: ${acc.balance}, Nickname: ${acc.nickname || 'N/A'}`;
                        accountsList.appendChild(li);
                    });
                } else {
                    accountsList.innerHTML = '<li>No accounts found for this customer.</li>';
                }

            } catch (error) {
                showResponse('viewCustomerResponse', 'Error: ' + error.message, false);
                detailsArea.style.display = 'none';
                reportLocationSection.style.display = 'none';
                currentLocationInfoDiv.style.display = 'none';
                currentCustomerIdForLocation = null;
            }
        }

        // Update Customer (Same as before)
        document.getElementById('updateCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = document.getElementById('updateCustIdHidden').value;
            const payload = {
                full_name: document.getElementById('updateFullName').value || undefined,
                email: document.getElementById('updateEmail').value || undefined,
                phone_number: document.getElementById('updatePhone').value || undefined,
            };
            Object.keys(payload).forEach(key => payload[key] === undefined && delete payload[key]);

            if (Object.keys(payload).length === 0) {
                showResponse('viewCustomerResponse', 'No changes to update.', false); return;
            }
            try {
                const data = await apiCall(`/customers/${customerId}`, 'PUT', payload);
                showResponse('viewCustomerResponse', 'Customer updated successfully!\n\n' + JSON.stringify(data, null, 2));
                 // Re-fetch to show updated details including any server-side changes
                fetchCustomerDetails();
            } catch (error) {
                showResponse('viewCustomerResponse', 'Error updating customer: ' + error.message, false);
            }
        });

        // Report Customer Location (NEW)
        document.getElementById('reportLocationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentCustomerIdForLocation) {
                showResponse('reportLocationResponse', 'No customer selected. Please view a customer first.', false);
                return;
            }

            const payload = {
                latitude: parseFloat(document.getElementById('locLatitude').value),
                longitude: parseFloat(document.getElementById('locLongitude').value),
                accuracy: document.getElementById('locAccuracy').value ? parseFloat(document.getElementById('locAccuracy').value) : null,
                // timestamp: new Date().toISOString() // Client-side timestamp, or let API set it
            };
            if (payload.accuracy === null) delete payload.accuracy;


            try {
                const data = await apiCall(`/customers/${currentCustomerIdForLocation}/location`, 'POST', payload);
                showResponse('reportLocationResponse', 'Location reported successfully!\n\n' + JSON.stringify(data, null, 2));
                // Update displayed location info
                document.getElementById('locLat').textContent = `Lat: ${data.last_known_latitude}`;
                document.getElementById('locLon').textContent = `Lon: ${data.last_known_longitude}`;
                document.getElementById('locAcc').textContent = `Accuracy: ${data.last_location_accuracy !== null ? data.last_location_accuracy + 'm' : 'N/A'}`;
                document.getElementById('locTime').textContent = `Timestamp: ${formatDate(data.last_location_timestamp)}`;

            } catch (error) {
                showResponse('reportLocationResponse', 'Error reporting location: ' + error.message, false);
            }
        });

        // Autofill location using browser's Geolocation API (NEW)
        function autofillBrowserLocation() {
            if (navigator.geolocation) {
                showResponse('reportLocationResponse', 'Fetching browser location...', true);
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('locLatitude').value = position.coords.latitude;
                        document.getElementById('locLongitude').value = position.coords.longitude;
                        if (position.coords.accuracy) {
                            document.getElementById('locAccuracy').value = position.coords.accuracy;
                        }
                        showResponse('reportLocationResponse', 'Browser location autofilled. You can now submit.', true);
                    },
                    (error) => {
                        let message = 'Error getting browser location: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED: message += "User denied the request for Geolocation."; break;
                            case error.POSITION_UNAVAILABLE: message += "Location information is unavailable."; break;
                            case error.TIMEOUT: message += "The request to get user location timed out."; break;
                            case error.UNKNOWN_ERROR: message += "An unknown error occurred."; break;
                        }
                        showResponse('reportLocationResponse', message, false);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showResponse('reportLocationResponse', 'Geolocation is not supported by this browser.', false);
            }
        }

    </script>
</body>
</html>
