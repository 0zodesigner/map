<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Ensure proper viewport scaling for full screen -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Full Screen Venue Finder</title>

    <!-- Mapbox GL JS CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- Basic Reset & Body --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; } /* Ensure html takes full height */
        body {
            height: 100vh; /* Full viewport height */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #ffffff; /* Default background */
            position: relative; /* Needed for absolute positioning context if any */
            overflow: hidden; /* Prevent body scrollbars when screens slide */
        }

        /* --- Screen Containers (Now Fixed for Fullscreen Overlay) --- */
        .screen {
            position: fixed; /* Fixed position to overlay */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Full viewport height */
            background-color: #fff;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            will-change: transform; /* Hint for performance */
        }
        .map-screen { z-index: 1; transform: translateX(0); /* Default visible screen */ }
        .filter-screen { z-index: 20; transform: translateY(100%); }
        .filter-screen.visible { transform: translateY(0); }
        .detail-screen { z-index: 30; transform: translateX(100%); background-color: #f8f8f8; }
        .detail-screen.visible { transform: translateX(0); }

        /* --- Common Top Bar / Nav (Reduced top padding) --- */
        .top-bar, .filter-nav, .detail-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            /* Use safe area for top inset on devices with notches/islands */
            padding-top: calc(10px + env(safe-area-inset-top));
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0; /* Prevent shrinking */
            position: relative; /* Ensure z-index works if needed */
            z-index: 15; /* Above map content */
        }
        .top-bar h1, .filter-nav h2, .detail-nav h2 { font-size: 16px; font-weight: 600; color: #333; text-align: center; flex-grow: 1; }
        .top-bar i, .filter-nav button, .detail-nav button { font-size: 20px; color: #007AFF; cursor: pointer; background: none; border: none; padding: 5px; }
        .filter-nav button, .detail-nav button { font-size: 16px; }
        .filter-nav button.apply, .detail-nav button.placeholder { font-weight: 600; color: #007AFF; }
        .detail-nav button.back-button { text-align: left; flex-grow: 0; min-width: 60px; }
        .detail-nav button.placeholder { min-width: 60px; visibility: hidden; }

        /* --- Map Screen Specific --- */
         .map-screen-content { /* New wrapper for flex layout */
             flex-grow: 1;
             position: relative; /* Context for map and overlays */
             display: flex; /* Use flex to manage map height */
             flex-direction: column;
         }
        .search-bar { display: flex; align-items: center; padding: 8px 15px; margin: 10px 15px; background-color: #f8f8f8; border-radius: 10px; border: 1px solid #eee; z-index: 5; flex-shrink: 0;}
        .search-bar i { color: #8e8e93; margin-right: 8px; }
        .search-bar input { flex-grow: 1; border: none; outline: none; background: transparent; font-size: 15px; }
        .search-bar input::placeholder { color: #c7c7cc; }
        #map {
            flex-grow: 1; /* Take remaining vertical space */
            position: relative; /* Position relative within its flex container */
            width: 100%; /* Ensure full width */
            min-height: 200px; /* Ensure map has some minimum height */
        }
        .map-overlay-buttons { position: absolute; bottom: 15px; /* Adjusted based on carousel */ right: 15px; z-index: 10; display: flex; flex-direction: column; gap: 10px; }
        .map-overlay-buttons button { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .map-overlay-buttons button i { font-size: 18px; color: #333; }

        /* --- Venue Carousel --- */
        .carousel-container {
            position: absolute; /* Position relative to map-screen-content */
            bottom: 0; /* Align to bottom of map content area */
            left: 0;
            width: 100%;
            z-index: 5;
            background: linear-gradient(to top, rgba(255,255,255,1) 50%, rgba(255,255,255,0.8) 70%, transparent);
            padding-top: 10px;
            /* Leave space for the tab bar below this container */
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* Match tab-bar height */
        }
        .venue-carousel { padding: 10px 0 15px 15px; overflow-x: scroll; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .venue-carousel::-webkit-scrollbar { display: none; }
        .venue-card { display: inline-block; width: 250px; background-color: #ffffff; border-radius: 12px; margin-right: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow: hidden; vertical-align: top; white-space: normal; cursor: pointer; }
        .venue-card img { width: 100%; height: 100px; object-fit: cover; display: block; background-color: #eee; }
        .venue-card .info { padding: 10px 12px; }
        .venue-card h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .venue-card .distance, .venue-card .categories, .venue-card .rating span { font-size: 12px; color: #666; margin-bottom: 4px; display: block; }
        .venue-card .distance i { margin-right: 4px; color: #888; }
        .venue-card .rating i { color: #ffa900; font-size: 11px; margin-right: 1px; }
        .venue-card .rating span { display: inline; margin-left: 5px; color: #888; }
        .venue-card .categories { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; color: #888; }
        .empty-state-message { text-align: center; color: #888; font-size: 14px; padding: 30px 15px; display: none; /* Hidden by default */ }

        /* --- Tab Bar (Fixed at bottom) --- */
        .tab-bar {
            position: fixed; /* Fixed position at viewport bottom */
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(65px + env(safe-area-inset-bottom)); /* Base height + safe area */
            padding-bottom: env(safe-area-inset-bottom); /* Safe area padding */
            background-color: rgba(255, 255, 255, 0.95); /* Slightly less transparent */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid #d0d0d0; /* Slightly darker border */
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            z-index: 10;
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #8e8e93; font-size: 10px; cursor: pointer; text-decoration: none; flex: 1; position: relative; }
        .tab-item i { font-size: 22px; margin-bottom: 3px; }
        .tab-item.active { color: #007AFF; }
        .tab-item.central-tab { margin-top: -20px; /* Adjust vertical offset */ }
        .tab-item.central-tab .icon-background { background-color: #007AFF; color: white; width: 48px; height: 48px; /* Slightly smaller */ border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; box-shadow: 0 3px 8px rgba(0, 122, 255, 0.4); }
        .tab-item.central-tab .icon-background i { font-size: 22px; margin: 0; }
        .tab-item.central-tab span { margin-top: 20px; /* Adjust text position */ }

        /* --- Filter Screen Specific --- */
        .filter-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .filter-section { margin-bottom: 30px; }
        .filter-section h3 { font-size: 15px; font-weight: 600; margin-bottom: 15px; color: #333; }
        .filter-tags, .filter-chips { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-tag { display: inline-flex; align-items: center; background-color: #eef1f4; color: #007AFF; padding: 6px 12px; border-radius: 15px; font-size: 13px; cursor: default; }
        .filter-tag i { margin-left: 6px; font-size: 12px; color: #a0a0a0; cursor: pointer; }
        .filter-chip { display: inline-flex; align-items: center; padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; background-color: #f8f8f8; border: 1px solid #f0f0f0; color: #333; transition: all 0.2s ease; }
        .filter-chip i { margin-right: 6px; font-size: 16px; color: #8e8e93; }
        .filter-chip.add-style i { color: #007AFF; }
        .filter-chip.selected { background-color: #e0efff; border-color: #b3d7ff; color: #0056b3; }
        .filter-chip.selected i { color: #007AFF; }
        .distance-slider { width: 100%; cursor: pointer; accent-color: #007AFF; }
        .distance-labels { display: flex; justify-content: space-between; font-size: 12px; color: #8e8e93; margin-top: 8px; }
        .toggle-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .toggle-item label { font-size: 15px; }
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0; } /* Prevent shrinking */
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9eb; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input:checked + .toggle-slider { background-color: #007AFF; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* --- Detail Screen Specific --- */
        .detail-content { flex-grow: 1; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); /* Space at bottom */}
        .detail-image-gallery { height: 30vh; /* Relative to viewport */ min-height: 200px; max-height: 300px; background-color: #ddd; display: flex; overflow-x: scroll; scroll-snap-type: x mandatory; flex-shrink: 0; }
        .detail-image-gallery img { width: 100%; height: 100%; object-fit: cover; flex-shrink: 0; scroll-snap-align: center; }
        .detail-info { padding: 20px; background-color: #fff; }
        .detail-info h3 { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
        .detail-info .categories, .detail-info .address, .detail-info .hours { font-size: 14px; color: #555; margin-bottom: 8px; display: flex; align-items: flex-start; }
        .detail-info .categories i, .detail-info .address i, .detail-info .hours i { color: #888; width: 20px; margin-right: 8px; text-align: center; margin-top: 2px;}
        .detail-actions { padding: 15px 20px; background-color: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .detail-actions button, .detail-actions a { flex: 1; padding: 12px; font-size: 15px; font-weight: 600; border-radius: 8px; text-align: center; cursor: pointer; text-decoration: none; }
        .detail-actions .directions { background-color: #007AFF; color: white; border: none;}
        .detail-actions .call, .detail-actions .website { background-color: #eef1f4; color: #007AFF; border: none;}
        #detailMapContainer { height: 150px; margin: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #eee;}
        #detailMap { width: 100%; height: 100%; }
        .detail-section { padding: 20px; background-color: #fff; margin-top: 10px; }
        .detail-section h4 { font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        .detail-reviews p, .detail-description p { font-size: 14px; color: #444; line-height: 1.5; }

        /* --- Mapbox Overrides & Markers --- */
        .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib { display: none !important; }
        .mapboxgl-marker { cursor: pointer; }
        .custom-marker { width: 24px; height: 24px; border-radius: 50%; background-color: #007AFF; border: 3px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center;}
        .custom-marker i { color: white; font-size: 12px; }
        .custom-marker.selected { background-color: #ff9500; }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: 8px; z-index: 100; font-size: 14px; }

    </style>
</head>
<body>
    <!-- No phone container -->

    <!-- ====== Loading Indicator ====== -->
    <div id="loadingIndicator" class="hidden">Filtering venues...</div>

    <!-- ====== MAP SCREEN ====== -->
    <div class="screen map-screen" id="mapScreen">
        <div class="top-bar">
            <i class="fa-solid fa-bars"></i>
            <h1>VENUES NEAR YOU</h1>
            <i class="fa-solid fa-sliders" id="filterIcon"></i>
        </div>
        <!-- Wrap map and search bar for flex layout -->
        <div class="map-screen-content">
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Search disabled in demo">
            </div>
            <div id='map'>
                 <div class="map-overlay-buttons">
                     <button id="recenterButton" title="Recenter on me">
                         <i class="fa-solid fa-location-crosshairs"></i>
                     </button>
                 </div>
            </div>
        </div>
        <!-- Carousel is positioned absolutely relative to map-screen-content -->
         <div class="carousel-container">
            <div class="venue-carousel" id="venueCarousel">
                <!-- Venue cards will be injected here -->
            </div>
             <div class="empty-state-message" id="emptyStateMessage">
                 No venues match your current filters.
             </div>
        </div>
    </div>

    <!-- ====== FILTER SCREEN ====== -->
    <div class="screen filter-screen" id="filterScreen">
        <div class="filter-nav">
            <button id="cancelFilterButton">Cancel</button>
            <h2>SEARCH FILTER</h2>
            <button class="apply" id="applyFilterButton">Apply</button>
        </div>
        <div class="filter-content">
            <!-- Filter sections remain the same -->
             <div class="filter-section hidden">
                 <h3>Applied filters</h3>
                 <div class="filter-tags" id="appliedFilterTags"></div>
             </div>
            <div class="filter-section">
                <h3>Category</h3>
                <div class="filter-chips" id="categoryFilters">
                    <button class="filter-chip" data-category="All">All</button>
                    <button class="filter-chip" data-category="Italian"><i class="fa-regular fa-circle"></i> Italian</button>
                    <button class="filter-chip" data-category="Cafe"><i class="fa-regular fa-circle"></i> Cafe</button>
                    <button class="filter-chip" data-category="Mexican"><i class="fa-regular fa-circle"></i> Mexican</button>
                    <button class="filter-chip" data-category="Bakery"><i class="fa-regular fa-circle"></i> Bakery</button>
                     <button class="filter-chip" data-category="Asian"><i class="fa-regular fa-circle"></i> Asian</button>
                </div>
            </div>
            <div class="filter-section">
                <h3>Max Distance (Simulated)</h3>
                <input type="range" min="1" max="50" value="50" class="distance-slider" id="distanceSlider">
                <div class="distance-labels">
                    <span>1km</span>
                    <span id="distanceValue">50km</span>
                    <span>50km</span>
                </div>
            </div>
            <div class="filter-section">
                 <div class="toggle-item">
                     <label for="nowOpenToggle">Now open (Toggle UI Only)</label>
                     <label class="toggle-switch">
                         <input type="checkbox" id="nowOpenToggle">
                         <span class="toggle-slider"></span>
                     </label>
                 </div>
                 <div class="toggle-item">
                    <label for="freeReservationToggle">Free reservation (Toggle UI Only)</label>
                     <label class="toggle-switch">
                         <input type="checkbox" id="freeReservationToggle">
                         <span class="toggle-slider"></span>
                     </label>
                 </div>
            </div>
        </div>
    </div>

     <!-- ====== DETAIL SCREEN ====== -->
    <div class="screen detail-screen" id="detailScreen">
         <div class="detail-nav">
             <button class="back-button" id="detailBackButton"><i class="fa-solid fa-chevron-left"></i> Back</button>
             <h2 id="detailVenueName">Venue Name</h2>
             <button class="placeholder">Back</button> <!-- Balance title -->
         </div>
         <div class="detail-content">
             <div class="detail-image-gallery" id="detailImageGallery"></div>
             <div class="detail-info">
                 <h3 id="detailInfoName">Venue Name</h3>
                 <div class="rating" id="detailRating"></div>
                 <div class="categories" id="detailCategories"><i class="fa-solid fa-tags"></i> <span></span></div>
                 <div class="address" id="detailAddress"><i class="fa-solid fa-location-dot"></i> <span></span></div>
                 <div class="hours" id="detailHours"><i class="fa-regular fa-clock"></i> <span></span></div>
             </div>
             <div class="detail-actions">
                <a id="detailDirectionsButton" href="#" target="_blank" class="directions">Directions</a>
                <a id="detailCallButton" href="#" class="call">Call</a>
                <a id="detailWebsiteButton" href="#" target="_blank" class="website">Website</a>
             </div>
             <div id="detailMapContainer">
                 <div id="detailMap"></div>
             </div>
             <div class="detail-section detail-description">
                <h4>Description</h4>
                <p id="detailDescription"></p>
             </div>
              <div class="detail-section detail-reviews">
                <h4>Reviews</h4>
                <p>Reviews section placeholder.</p>
             </div>
         </div>
     </div>

    <!-- Tab Bar (Fixed at bottom, outside of screens) -->
    <div class="tab-bar">
        <a href="#" class="tab-item" data-tab="settings"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
        <a href="#" class="tab-item central-tab active" data-tab="map"><div class="icon-background"><i class="fa-solid fa-map-location-dot"></i></div><span>Explore</span></a>
        <a href="#" class="tab-item" data-tab="activity"><i class="fa-solid fa-chart-line"></i><span>Activity</span></a>
    </div>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>

    <script>
        // --- Configuration, State, Data (Same as before) ---
        mapboxgl.accessToken = 'pk.eyJ1Ijoib3BlbnN0cmVldGNhbSIsImEiOiJja252Ymh4ZnIwNHdkMnd0ZzF5NDVmdnR5In0.dYxz3TzZPTPzd_ibMeGK2g'; // Public token
        const initialCenter = [-118.2673, 34.0440];
        const initialZoom = 13;
        let map;
        let detailMap;
        let currentMarkers = [];
        let currentFilters = { category: 'All', maxDistance: 50 };
        let lastUserLocation = null;
        const allVenues = [
            { id: 'v1', name: "The Palm Los Angeles", coordinates: [-118.2676, 34.0452], distance: 0.2, rating: 4.5, reviewCount: 12, categories: ["Italian", "Steakhouse"], imageUrls: ["https://via.placeholder.com/375x250/A0A0A0/FFFFFF?text=Palm+1", "https://via.placeholder.com/375x250/C0C0C0/FFFFFF?text=Palm+2"], address: "1100 S Flower St, Los Angeles, CA 90015", phone: "+12137634600", website: "https://www.thepalm.com/", openingHours: "Mon-Sat 11:30 AM - 10 PM", description: "Classic American steakhouse known for caricatures on the walls." },
            { id: 'v2', name: "Bottega Louie", coordinates: [-118.2568, 34.0468], distance: 1.2, rating: 4.7, reviewCount: 55, categories: ["Italian", "Bakery", "Cafe"], imageUrls: ["https://via.placeholder.com/375x250/B0B0B0/FFFFFF?text=Louie+1"], address: "700 S Grand Ave, Los Angeles, CA 90017", phone: "+12138021470", website: "https://www.bottegalouie.com/", openingHours: "Daily 9 AM - 9 PM", description: "Popular spot for macarons, pizza, and brunch in a grand setting."},
            { id: 'v3', name: "Guisados DTLA", coordinates: [-118.2488, 34.0480], distance: 1.8, rating: 4.6, reviewCount: 40, categories: ["Mexican"], imageUrls: ["https://via.placeholder.com/375x250/D0D0D0/FFFFFF?text=Guisados+1"], address: "541 S Spring St #101, Los Angeles, CA 90013", phone: "+12136277656", website: "https://www.guisados.co/", openingHours: "Daily 10 AM - 8 PM", description: "Homestyle braised meat tacos on fresh handmade tortillas." },
            { id: 'v4', name: "Verve Coffee Roasters", coordinates: [-118.2585, 34.0475], distance: 1.0, rating: 4.4, reviewCount: 25, categories: ["Cafe", "Bakery"], imageUrls: ["https://via.placeholder.com/375x250/E0E0E0/FFFFFF?text=Verve+1"], address: "833 S Spring St, Los Angeles, CA 90014", phone: "+12134555971", website: "https://www.vervecoffee.com/", openingHours: "Daily 7 AM - 6 PM", description: "Artisanal coffee shop with a focus on quality beans and brewing methods." },
            { id: 'v5', name: "Marugame Monzo", coordinates: [-118.2476, 34.0490], distance: 2.0, rating: 4.8, reviewCount: 60, categories: ["Asian", "Japanese"], imageUrls: ["https://via.placeholder.com/375x250/F0F0F0/FFFFFF?text=Monzo+1"], address: "329 E 1st St, Los Angeles, CA 90012", phone: "+12133469762", website: "https://marugamemonzola.com/", openingHours: "Tue-Sun 11:30 AM - 10 PM", description: "Famous for handmade udon noodles served hot or cold." }
        ];

        // --- DOM Elements (Same as before) ---
         const mapElement = document.getElementById('map');
         const detailMapElement = document.getElementById('detailMap');
         const mapScreen = document.getElementById('mapScreen');
         const filterScreen = document.getElementById('filterScreen');
         const detailScreen = document.getElementById('detailScreen');
         const filterIcon = document.getElementById('filterIcon');
         const cancelFilterButton = document.getElementById('cancelFilterButton');
         const applyFilterButton = document.getElementById('applyFilterButton');
         const detailBackButton = document.getElementById('detailBackButton');
         const venueCarousel = document.getElementById('venueCarousel');
         const categoryFilterChips = document.querySelectorAll('#categoryFilters .filter-chip');
         const distanceSlider = document.getElementById('distanceSlider');
         const distanceValueDisplay = document.getElementById('distanceValue');
         const loadingIndicator = document.getElementById('loadingIndicator');
         const emptyStateMessage = document.getElementById('emptyStateMessage');
         const recenterButton = document.getElementById('recenterButton');

        // --- Map Initialization (Same as before) ---
        function initializeMainMap() {
            if (map) return; // Prevent re-initialization
            try {
                map = new mapboxgl.Map({
                    container: mapElement,
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: initialCenter,
                    zoom: initialZoom,
                    pitch: 10
                });
                map.on('load', () => { console.log('Main map loaded'); applyFiltersAndRender(); });
                map.on('error', (e) => { console.error('Mapbox error:', e); mapElement.innerHTML = '<p>Error loading map.</p>'; });
            } catch(e) {
                 console.error("Map init error:", e); mapElement.innerHTML = '<p>Error loading map.</p>';
            }
        }
        function initializeDetailMap(venue) {
            if (detailMap) { detailMap.remove(); detailMap = null; }
            requestAnimationFrame(() => {
                if (detailMapElement.offsetWidth > 0 && detailMapElement.offsetHeight > 0) {
                    try {
                        detailMap = new mapboxgl.Map({
                            container: detailMapElement, style: 'mapbox://styles/mapbox/streets-v12',
                            center: venue.coordinates, zoom: 15, interactive: false
                        });
                        detailMap.on('load', () => {
                            new mapboxgl.Marker({ color: '#ff9500' }).setLngLat(venue.coordinates).addTo(detailMap);
                            console.log('Detail map loaded for:', venue.name);
                        });
                        detailMap.on('error', (e) => console.error('Detail Mapbox error:', e));
                    } catch (error) {
                        console.error("Error initializing detail map:", error); detailMapElement.innerHTML = '<p>Could not load map.</p>';
                    }
                } else { setTimeout(() => initializeDetailMap(venue), 100); }
            });
        }

        // --- Rendering Functions (Same as before) ---
        function renderMapMarkers(venuesToShow) {
            currentMarkers.forEach(marker => marker.remove());
            currentMarkers = [];
            venuesToShow.forEach(venue => {
                const el = document.createElement('div');
                el.className = 'custom-marker';
                el.innerHTML = '<i class="fa-solid fa-shop"></i>';
                el.dataset.venueId = venue.id;
                const marker = new mapboxgl.Marker(el).setLngLat(venue.coordinates).addTo(map);
                el.addEventListener('click', () => { showDetailScreen(venue.id); });
                currentMarkers.push(marker);
            });
            console.log(`Rendered ${venuesToShow.length} markers.`);
        }
        function renderVenueCarousel(venuesToShow) {
            venueCarousel.innerHTML = '';
            emptyStateMessage.style.display = venuesToShow.length === 0 ? 'block' : 'none';
            if (venuesToShow.length === 0) return;

            venuesToShow.forEach(venue => {
                const ratingStars = Array(5).fill(0).map((_, i) => i < Math.floor(venue.rating) ? '<i class="fa-solid fa-star"></i>' : (i < venue.rating ? '<i class="fa-solid fa-star-half-stroke"></i>' : '<i class="fa-regular fa-star"></i>')).join('');
                venueCarousel.insertAdjacentHTML('beforeend', `
                    <div class="venue-card" data-venue-id="${venue.id}">
                        <img src="${venue.imageUrls[0]}" alt="${venue.name}" loading="lazy">
                        <div class="info"><h4>${venue.name}</h4><span class="distance"><i class="fa-solid fa-location-arrow"></i>${venue.distance}km (Mock)</span><div class="rating">${ratingStars}<span>${venue.reviewCount} reviews</span></div><span class="categories">${venue.categories.join(' · ')}</span></div></div>`);
            });
            venueCarousel.querySelectorAll('.venue-card').forEach(card => card.addEventListener('click', () => showDetailScreen(card.dataset.venueId)));
            console.log(`Rendered ${venuesToShow.length} cards.`);
        }

        // --- Filtering Logic (Same as before) ---
        function applyFiltersAndRender() {
            showLoading(true);
            setTimeout(() => {
                console.log("Applying filters:", currentFilters);
                let filteredVenues = [...allVenues].filter(venue =>
                    (currentFilters.category === 'All' || venue.categories.includes(currentFilters.category)) &&
                    (venue.distance <= currentFilters.maxDistance)
                    // && (filter by isOpenNow if implemented)
                );
                console.log(`Filtering complete, ${filteredVenues.length} venues matched.`);
                if(map && map.isStyleLoaded()) { // Ensure map is ready before rendering
                     renderMapMarkers(filteredVenues);
                } else {
                     console.warn("Map not ready for rendering markers yet.");
                     // Optionally retry or wait for map load event
                }
                renderVenueCarousel(filteredVenues);
                showLoading(false);
            }, 300);
        }

        // --- Screen Navigation & Interaction (Same as before) ---
        function showFilterScreen() { filterScreen.classList.add('visible'); updateFilterUI(); }
        function hideFilterScreen() { filterScreen.classList.remove('visible'); }
        function showDetailScreen(venueId) {
            const venue = allVenues.find(v => v.id === venueId);
            if (!venue) { console.error("Venue not found:", venueId); return; }
            populateDetailScreen(venue);
            detailScreen.classList.add('visible');
            initializeDetailMap(venue);
        }
        function hideDetailScreen() {
            detailScreen.classList.remove('visible');
            if (detailMap) { detailMap.remove(); detailMap = null; console.log('Detail map removed.'); }
        }
        function populateDetailScreen(venue) {
            document.getElementById('detailVenueName').textContent = venue.name;
            document.getElementById('detailInfoName').textContent = venue.name;
            document.getElementById('detailAddress').querySelector('span').textContent = venue.address;
            document.getElementById('detailHours').querySelector('span').textContent = venue.openingHours;
            document.getElementById('detailCategories').querySelector('span').textContent = venue.categories.join(', ');
            document.getElementById('detailDescription').textContent = venue.description || "No description.";
            const ratingStars = Array(5).fill(0).map((_, i) => i < Math.floor(venue.rating) ? '<i class="fa-solid fa-star"></i>' : (i < venue.rating ? '<i class="fa-solid fa-star-half-stroke"></i>' : '<i class="fa-regular fa-star"></i>')).join('');
            document.getElementById('detailRating').innerHTML = `${ratingStars} <span style="font-size: 13px; color: #666; margin-left: 5px;">(${venue.reviewCount} reviews)</span>`;
            const gallery = document.getElementById('detailImageGallery'); gallery.innerHTML = '';
            venue.imageUrls.forEach(url => { gallery.innerHTML += `<img src="${url}" alt="${venue.name}" loading="lazy">`; });
            const encodedAddress = encodeURIComponent(venue.address);
            document.getElementById('detailDirectionsButton').href = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            document.getElementById('detailCallButton').href = venue.phone ? `tel:${venue.phone}` : '#';
            document.getElementById('detailCallButton').style.opacity = venue.phone ? 1 : 0.5;
            document.getElementById('detailWebsiteButton').href = venue.website || '#';
            document.getElementById('detailWebsiteButton').style.opacity = venue.website ? 1 : 0.5;
            document.getElementById('detailWebsiteButton').target = venue.website ? '_blank' : '_self';
        }
        function showLoading(isLoading) { loadingIndicator.classList.toggle('hidden', !isLoading); }
        function updateFilterUI() {
            categoryFilterChips.forEach(chip => {
                const isSelected = chip.dataset.category === currentFilters.category;
                chip.classList.toggle('selected', isSelected);
                const icon = chip.querySelector('i');
                if (icon) icon.className = isSelected ? 'fa-solid fa-check' : 'fa-regular fa-circle';
            });
            distanceSlider.value = currentFilters.maxDistance;
            distanceValueDisplay.textContent = `${currentFilters.maxDistance}km`;
        }

        // --- Event Listeners (Same as before) ---
        filterIcon.addEventListener('click', showFilterScreen);
        cancelFilterButton.addEventListener('click', hideFilterScreen);
        detailBackButton.addEventListener('click', hideDetailScreen);
        applyFilterButton.addEventListener('click', () => {
            const selectedCategoryChip = document.querySelector('#categoryFilters .filter-chip.selected');
            currentFilters.category = selectedCategoryChip ? selectedCategoryChip.dataset.category : 'All';
            currentFilters.maxDistance = parseInt(distanceSlider.value, 10);
            applyFiltersAndRender();
            hideFilterScreen();
        });
        categoryFilterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                categoryFilterChips.forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
                categoryFilterChips.forEach(c => { const icon = c.querySelector('i'); if (icon) icon.className = 'fa-regular fa-circle'; });
                const selectedIcon = chip.querySelector('i'); if (selectedIcon) selectedIcon.className = 'fa-solid fa-check';
            });
        });
        distanceSlider.addEventListener('input', (e) => { distanceValueDisplay.textContent = `${e.target.value}km`; });
        recenterButton.addEventListener('click', () => {
            if (navigator.geolocation) {
                showLoading(true);
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        lastUserLocation = [position.coords.longitude, position.coords.latitude];
                        map.flyTo({ center: lastUserLocation, zoom: 14 });
                        showLoading(false);
                    }, (error) => { console.error("Geo error:", error); alert("Could not get location."); showLoading(false); },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else { alert("Geolocation not supported."); }
        });
        document.querySelectorAll('.tab-bar .tab-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.tab-bar .tab-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                // Add logic here to actually switch content if needed (beyond map screen)
            });
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMainMap();
            updateFilterUI(); // Set initial filter UI state
        });

    </script>

</body>
</html>
